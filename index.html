<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆæ­¸çš„åƒç‹æ™‚é–“è¡¨</title>
    <style>
        /* --- æ¨£å¼è¨­å®š --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #202225; color: #dcddde; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #2f3136; padding-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        h2 { color: #f04747; margin: 0; font-size: 1.6rem; display: flex; align-items: center; gap: 10px; text-shadow: 1px 1px 2px black;}
        
        .btn { border: none; padding: 10px 18px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; font-size: 0.9rem;}
        .btn-copy { background-color: #43b581; }
        .btn-copy:hover { background-color: #3ca374; }
        .btn-reset { background-color: #ed4245; font-size: 0.8rem;}
        
        .boss-card { background-color: #2f3136; padding: 12px 18px; margin-bottom: 10px; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-left: 6px solid #72767d; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color 0.3s, border-color 0.3s; }
        
        .status-active { border-left-color: #ed4245 !important; background-color: #382627 !important; }
        .status-soon { border-left-color: #f1c40f !important; background-color: #363328 !important; }
        .status-cd { border-left-color: #5865F2 !important; }
        .status-fixed { border-left-color: #9b59b6 !important; }
        
        .boss-info { flex-grow: 1; min-width: 220px; margin-right: 15px; }
        .boss-top-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
        .boss-name { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .boss-meta { font-size: 0.75rem; background: #4f545c; padding: 3px 8px; border-radius: 10px; color: #eee; }
        .boss-loc { font-size: 0.9rem; color: #b9bbbe; }
        
        .boss-timer { font-size: 1.4rem; font-weight: bold; color: #dcddde; margin-top: 5px; font-family: 'Consolas', monospace; letter-spacing: 1px;}
        .highlight-text { color: #f1c40f; text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
        .boss-predict { font-size: 0.9rem; color: #888; margin-top: 2px; }

        .input-group { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; min-width: 240px; justify-content: center;}
        .input-row { display: flex; gap: 5px; width: 100%; justify-content: flex-end;}
        
        input[type="datetime-local"] { background: #40444b; border: 1px solid #202225; color: white; padding: 8px; border-radius: 4px; font-family: sans-serif; font-size: 0.95rem; cursor: pointer; width: 100%; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        .btn-update { background-color: #5865F2; padding: 8px 15px; width: 80px;}
        .btn-update:hover { background-color: #4752c4; }

        .auto-tag { background-color: #2f3136; border: 1px solid #9b59b6; color: #9b59b6; padding: 8px 15px; border-radius: 4px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }

        .tip { font-size: 0.85rem; color: #999; margin-top: 30px; text-align: center; border-top: 1px solid #333; padding-top: 15px;}
        
        /* éŒ¯èª¤è¨Šæ¯å°ˆç”¨æ¡† */
        #rescue-console { display: none; background: #500; color: #fff; padding: 20px; margin-bottom: 20px; border: 2px solid red; white-space: pre-wrap; font-size: 1rem; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div id="rescue-console"></div>

    <div class="header-area">
        <h2>âš”ï¸æœˆæ­¸çš„åƒç‹æ™‚é–“è¡¨âš”ï¸</h2>
        <button class="btn btn-reset" onclick="hardReset()">âš ï¸ é‡ç½®å›é è¨­å€¼</button>
        <button class="btn btn-copy" onclick="copyToDiscord()">ğŸ“‹ è¤‡è£½åˆ° Discord</button>
    </div>

    <div id="bossList">
        <div style="text-align:center; padding: 50px; color: #aaa;">
            æ­£åœ¨å•Ÿå‹•ç³»çµ±...<br>
            (å¦‚æœæ­¤ç•«é¢åœç•™è¶…é 2 ç§’ï¼Œä»£è¡¨ç¨‹å¼é‡åˆ°é˜»ç¤™)
        </div>
    </div>

    <div class="tip">
        <strong>v12.1 æ•‘æ´ç‰ˆï¼š</strong><br>
        å·²å…§å»ºéŒ¯èª¤åµæ¸¬ç³»çµ±ï¼Œè‹¥ç¨‹å¼å¡ä½æœƒè‡ªå‹•å›å ±åŸå› ã€‚
    </div>
</div>

<script>
// --- å…¨å±€éŒ¯èª¤æ””æˆª (æœ€å„ªå…ˆåŸ·è¡Œ) ---
window.onerror = function(msg, url, line, col, error) {
    const box = document.getElementById('rescue-console');
    box.style.display = 'block';
    box.innerHTML = `<h3>ğŸš¨ ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤</h3><p>${msg}</p><p>ä½ç½®: Line ${line}</p><p>è«‹æˆªåœ–æ­¤ç•«é¢å›å ±ï¼Œæˆ‘å€‘æœƒç«‹å³ä¿®å¾©ã€‚</p>`;
    return false;
};

// --- 1. è³‡æ–™è¨­å®š ---
const rawData = [
    { name: "åŸƒå¥‡ç´å¾·(25)", cd: 24, type: "fixed", loc: "ç‘ªé­¯æ£®æ—", fixTime: "12:00" },
    { name: "æ–¯å‰æ‹‰(30)", cd: 24, type: "fixed", loc: "é›²ä¹‹é«˜åŸ", fixTime: "14:00" },
    { name: "èœ¥èœ´äººåœ‹ç‹(35)", cd: 24, type: "fixed", loc: "è‰¾æ‹‰æº«æºªè°·", fixTime: "16:00" },
    { name: "äºçˆ¾è²¢(40)", cd: 24, type: "fixed", loc: "ç«ç´…è’é‡", fixTime: "18:00" },
    { name: "åšå¡é “(45)", cd: 24, type: "fixed", loc: "æ¥­å ±3F", fixTime: "20:00" },
    { name: "æ³°ç±³çˆ¾(48)", cd: 24, type: "fixed", loc: "å°¼å¤«èŠçˆ¾åŸ", fixTime: "22:00" },
    
    { name: "æ™®é­¯ç‰¹(65)", cd: 6, type: "cd", loc: "åœ°ç„3F", initTime: "1/8 10:15" },
    { name: "æ ¼é‡Œè²¢(55)", cd: 12, type: "cd", loc: "å€’è½‰ç«ç´…è’é‡", initTime: "1/8 15:15" },
    { name: "ä½©çˆ¾(77)", cd: 24, type: "cd", loc: "ç½ªæƒ¡3F", initTime: "1/8 15:15" },
    { name: "äºæ‹‰é‡‘(78)", cd: 24, type: "cd", loc: "é›·æ­åŸ", initTime: "1/8 15:19" }, 
    { name: "å¡å¨å› (84)", cd: 24, type: "cd", loc: "æ¥è¾±çš„ç¥å»Ÿ", initTime: "1/8 15:20" },
    { name: "å¸•ææ´›æ–¯(60)", cd: 6, type: "cd", loc: "å€’è½‰å¡ç´å…‹å³½è°·", initTime: "1/8 15:23" },
    { name: "EZ-09(62)", cd: 12, type: "cd", loc: "å€’è½‰å¤ä»£éºè·¡", initTime: "1/8 15:29" },
    { name: "ç¶­ç‘Ÿæ–¯(72)", cd: 9, type: "cd", loc: "æ‹‰ç±³æ–¯æ£®æ—", initTime: "1/8 18:28" },
    { name: "æ­¦åº«æ‹‰(50)", cd: 13.5, type: "cd", loc: "å€’è½‰è‰¾æ‹‰æº«æºªè°·", initTime: "1/8 18:14" },
    { name: "å¸ƒèŠç™»(63)", cd: 18, type: "cd", loc: "æ¥­å ±6F", initTime: "1/9 03:15" },
    { name: "å“ˆå°¼æ–‡(68)", cd: 18, type: "cd", loc: "ç‘ªå‹’è–©æµ·å²¸", initTime: "1/8 14:45" }
];

const STORAGE_KEY = 'zenonia_boss_v12_rescue';
let bosses = [];

// --- 2. è¼”åŠ©å‡½å¼ ---
function parseInitTime(str) {
    if(!str) return null;
    try {
        const now = new Date();
        let year = now.getFullYear();
        let month = now.getMonth();
        let day = now.getDate();
        let dPart = "", tPart = str;
        if(str.includes(' ')) { const sp = str.split(' '); dPart = sp[0]; tPart = sp[1]; }
        if(dPart && dPart.includes('/')) { const dp = dPart.split('/'); month = parseInt(dp[0]) - 1; day = parseInt(dp[1]); }
        const tp = tPart.split(':');
        return new Date(year, month, day, parseInt(tp[0]), parseInt(tp[1]), 0).getTime();
    } catch(e) { return null; }
}

// --- 3. æ ¸å¿ƒé‚è¼¯ ---

function init() {
    // å¼·åˆ¶é‡ç½®ä¸€æ¬¡ï¼Œé¿å…èˆŠè³‡æ–™å¡ä½
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const savedData = JSON.parse(saved);
            bosses = rawData.map((b, idx) => {
                // å›ºå®šç‹æ°¸é é‡ç®—ï¼Œä¸è®€å–å­˜æª”
                if (b.type === 'fixed') {
                    return { ...b, id: idx, nextSpawn: null };
                }
                const old = savedData.find(s => s.name === b.name);
                let spawn = old ? old.nextSpawn : parseInitTime(b.initTime);
                return { ...b, id: idx, nextSpawn: spawn };
            });
        } else {
            loadDefaults();
        }
        
        recalcFixedBosses(); // è¨ˆç®—å›ºå®šç‹
        renderStaticList();  // ç•«å‡ºåˆ—è¡¨
        updateTimers();      // å•Ÿå‹•å€’æ•¸
        
        // å•Ÿå‹•å¾ªç’°
        setInterval(() => {
            recalcFixedBosses();
            updateTimers();
        }, 1000);
        
    } catch (e) {
        throw new Error("åˆå§‹åŒ–å¤±æ•—: " + e.message); // æ‹‹å‡ºéŒ¯èª¤è®“ onerror æ•æ‰
    }
}

function loadDefaults() {
    bosses = rawData.map((b, idx) => ({
        ...b,
        id: idx,
        nextSpawn: b.type === 'fixed' ? null : parseInitTime(b.initTime)
    }));
    saveData();
}

function recalcFixedBosses() {
    const now = new Date();
    bosses.forEach(boss => {
        if (boss.type === 'fixed' && boss.fixTime) {
            const [fh, fm] = boss.fixTime.split(':').map(Number);
            let target = new Date();
            target.setHours(fh, fm, 0, 0);
            
            // è‹¥ä»Šå¤©æ™‚é–“å·²éï¼Œå‰‡è¨­ç‚ºæ˜å¤©
            if (now.getTime() > target.getTime()) {
                target.setDate(target.getDate() + 1);
            }
            boss.nextSpawn = target.getTime();
        }
    });
}

function renderStaticList() {
    const list = document.getElementById('bossList');
    if(!list) return;

    const sorted = [...bosses].sort((a,b) => {
        if(!a.nextSpawn) return 1;
        if(!b.nextSpawn) return -1;
        return a.nextSpawn - b.nextSpawn;
    });

    let html = "";
    sorted.forEach(boss => {
        let inputHtml = "";
        if (boss.type === 'fixed') {
            inputHtml = `<div class="auto-tag">ğŸ”„ è‡ªå‹•å¾ªç’°</div>`;
        } else {
            inputHtml = `
                <div class="input-row">
                    <input type="datetime-local" id="in-${boss.id}">
                    <button class="btn btn-update" onclick="update(${boss.id})">æ›´æ–°</button>
                </div>`;
        }

        html += `
            <div id="card-${boss.id}" class="boss-card">
                <div class="boss-info">
                    <div class="boss-top-row">
                        <div class="boss-name">${boss.name}</div>
                        <div class="boss-meta">${boss.type === 'fixed' ? 'å›ºå®š ' + boss.fixTime : 'CD:' + boss.cd + 'h'}</div>
                    </div>
                    <div class="boss-loc">ğŸ“ ${boss.loc}</div>
                    <div id="timer-${boss.id}" class="boss-timer">-- : --</div>
                    <div id="predict-${boss.id}" class="boss-predict">é è¨ˆ: ---</div>
                </div>
                <div class="input-group">${inputHtml}</div>
            </div>`;
    });
    list.innerHTML = html;
}

function updateTimers() {
    const now = new Date().getTime();
    bosses.forEach(boss => {
        const cardEl = document.getElementById(`card-${boss.id}`);
        const timerEl = document.getElementById(`timer-${boss.id}`);
        const predictEl = document.getElementById(`predict-${boss.id}`);
        
        if (!cardEl || !timerEl) return; // å…ƒç´ é‚„æ²’ç•«å¥½å°±è·³é

        let statusClass = "status-cd"; 
        let timerText = "-- : --";
        let predictText = "---";
        let isHighlight = false;

        if (boss.nextSpawn) {
            const diff = boss.nextSpawn - now;
            const d = new Date(boss.nextSpawn);
            predictText = `é è¨ˆ: ${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

            if (diff <= 0) {
                statusClass = "status-active"; 
                timerText = "ğŸ”¥ å·²å‡ºç¾";
                isHighlight = true;
            } else {
                const hh = Math.floor(diff / 3600000);
                const mm = Math.floor((diff % 3600000) / 60000);
                const ss = Math.floor((diff % 60000) / 1000);
                timerText = `${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;

                if (diff < 600000) { 
                    statusClass = "status-soon"; 
                    isHighlight = true;
                } else if (boss.type === 'fixed') {
                    statusClass = "status-fixed";
                }
            }
        }

        timerEl.innerText = timerText;
        predictEl.innerText = predictText;
        
        cardEl.classList.remove('status-active', 'status-soon', 'status-cd', 'status-fixed');
        if (statusClass) cardEl.classList.add(statusClass);
        
        if (isHighlight) timerEl.classList.add('highlight-text');
        else timerEl.classList.remove('highlight-text');
    });
}

function saveData() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(bosses));
    } catch(e) { console.error("å­˜æª”å¤±æ•—", e); }
}

// --- 4. æ“ä½œå‡½å¼ ---
window.update = function(id) {
    const input = document.getElementById(`in-${id}`);
    if(!input || !input.value) return alert("è«‹é»é¸æœˆæ›†åœ–ç¤ºé¸æ“‡æ“Šæ®ºæ—¥æœŸèˆ‡æ™‚é–“ï¼");
    
    const killTime = new Date(input.value).getTime();
    if(isNaN(killTime)) return alert("æ™‚é–“æ ¼å¼éŒ¯èª¤");

    const boss = bosses.find(b => b.id === id);
    if (!boss) return;

    if (boss.type === 'cd') {
        const addMin = boss.cd * 60;
        let nextTime = new Date(killTime);
        nextTime.setMinutes(nextTime.getMinutes() + addMin);
        boss.nextSpawn = nextTime.getTime();
        
        input.value = ""; 
        saveData();
        renderStaticList(); // åªæœ‰æ‰‹å‹•æ›´æ–°æ™‚æ‰é‡æ’åˆ—è¡¨
    }
};

window.hardReset = function() {
    if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ä¸¦é‡ç½®å—ï¼Ÿ")) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
};

window.copyToDiscord = function() {
    const now = new Date().getTime();
    const list = [...bosses].filter(b => b.nextSpawn).sort((a,b) => a.nextSpawn - b.nextSpawn);
    
    let text = "ğŸ“¢ **æœˆæ­¸çš„åƒç‹æ™‚é–“è¡¨**\n https://willa0916.github.io/zenonia-boss/ \n ```diff\n";
    list.forEach(b => {
        const d = new Date(b.nextSpawn);
        const tStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        const diff = b.nextSpawn - now;
        let icon = "-";
        if (diff <= 0) icon = "+";
        else if (diff < 600000) icon = "!";
        text += `${icon} ${b.name} (${b.loc})\n      æ™‚é–“: ${tStr}\n`;
    });
    text += "```";
    navigator.clipboard.writeText(text).then(()=>alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼")).catch(()=>alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–"));
};

// ç¢ºä¿ DOM è¼‰å…¥å¾ŒåŸ·è¡Œ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>
</body>
</html>
