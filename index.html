<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆæ­¸åƒç‹æ™‚é–“è¡¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* --- æ¨£å¼è¨­å®š --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #202225; color: #dcddde; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #2f3136; padding-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        h2 { color: #f04747; margin: 0; font-size: 1.6rem; display: flex; align-items: center; gap: 10px; text-shadow: 1px 1px 2px black;}
        
        .btn { border: none; padding: 10px 18px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; font-size: 0.9rem;}
        .btn-copy { background-color: #43b581; } 
        .btn-reset { background-color: #ed4245; font-size: 0.8rem;}
        .btn-discord { background-color: #5865F2; }
        .btn-discord:hover { background-color: #4752c4; }
        
        /* é€£ç·šç‹€æ…‹ç‡ˆè™Ÿ */
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #43b581; box-shadow: 0 0 5px #43b581; }
        .offline { background-color: #ed4245; }

        .webhook-area { background: #2f3136; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #5865F2; display: flex; gap: 10px; align-items: center;}
        .webhook-input { background: #40444b; border: 1px solid #202225; color: white; padding: 8px; border-radius: 4px; flex-grow: 1; font-family: monospace;}
        
        .boss-card { background-color: #2f3136; padding: 12px 18px; margin-bottom: 10px; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-left: 6px solid #72767d; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color 0.3s, border-color 0.3s; }
        
        .status-active { border-left-color: #ed4245 !important; background-color: #382627 !important; }
        .status-soon { border-left-color: #f1c40f !important; background-color: #363328 !important; }
        .status-cd { border-left-color: #5865F2 !important; }
        .status-fixed { border-left-color: #9b59b6 !important; }
        
        .boss-info { flex-grow: 1; min-width: 220px; margin-right: 15px; }
        .boss-top-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
        .boss-name { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .boss-meta { font-size: 0.75rem; background: #4f545c; padding: 3px 8px; border-radius: 10px; color: #eee; }
        .boss-loc { font-size: 0.9rem; color: #b9bbbe; }
        
        /* è¨ˆæ™‚å™¨æ¨£å¼ */
        .boss-timer { font-size: 1.4rem; font-weight: bold; color: #dcddde; margin-top: 5px; font-family: 'Consolas', monospace; letter-spacing: 1px;}
        .highlight-text { color: #f1c40f; text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
        
        /* [ä¿®æ”¹] å‡ºç¾æ™‚é–“æ›´é¡¯çœ¼ */
        .boss-predict { font-size: 1rem; color: #43b581; margin-top: 5px; font-weight: bold; }

        .input-group { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; min-width: 260px; justify-content: center;}
        .input-row { display: flex; gap: 5px; width: 100%; justify-content: flex-end;}
        
        input.flatpickr-input { background: #40444b; border: 1px solid #202225; color: white; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.95rem; cursor: pointer; width: 140px; text-align: center; }

        /* [ä¿®æ”¹] æŒ‰éˆ•å¯¬åº¦è‡ªé©æ‡‰ï¼Œä»¥å®¹ç´æ›´å¤šæ–‡å­— */
        .btn-update { background-color: #5865F2; padding: 8px 12px; width: auto; min-width: 80px;}
        .btn-update:hover { background-color: #4752c4; }

        .auto-tag { background-color: #2f3136; border: 1px solid #9b59b6; color: #9b59b6; padding: 8px 15px; border-radius: 4px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }

        .tip { font-size: 0.85rem; color: #999; margin-top: 30px; text-align: center; border-top: 1px solid #333; padding-top: 15px;}
        #rescue-console { display: none; background: #500; color: #fff; padding: 20px; margin-bottom: 20px; border: 2px solid red; white-space: pre-wrap; font-size: 1rem; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div id="rescue-console"></div>

    <div class="header-area">
        <h2>
            <span id="conn-status" class="status-dot"></span>
            âš”ï¸æœˆæ­¸çš„åƒç‹æ™‚é–“è¡¨âš”ï¸
        </h2>
        <div style="display:flex; gap:10px; flex-wrap: wrap;">
            <button class="btn btn-reset" onclick="hardReset()">âš ï¸ å¼·åˆ¶é‡ç½®</button>
            <button class="btn btn-copy" onclick="copyToClipboard()">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
            <button class="btn btn-discord" onclick="sendToDiscord()">ğŸš€ ç™¼é€åˆ° Discord</button>
        </div>
    </div>
    
    <div class="webhook-area">
        <span style="font-size:0.9rem; color:#bbb;">Webhook:</span>
        <input type="password" id="webhook-url" class="webhook-input" placeholder="è«‹è²¼ä¸Š Discord Webhook URL">
        <button class="btn btn-copy" onclick="saveWebhook()" style="padding: 5px 10px; font-size: 0.8rem;">ğŸ’¾ å„²å­˜</button>
    </div>

    <div id="bossList">
        <div style="text-align:center; padding: 50px; color: #aaa;">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</div>
    </div>

    <div class="tip">
        <strong>v19.0 æ›´æ–°ï¼š</strong><br>
        è¼¸å…¥æ¡†é è¨­ç‚ºç©ºç™½ä»¥é˜²èª¤è§¸ï¼›æŒ‰éˆ•æ–‡å­—èˆ‡å€’æ•¸é¡¯ç¤ºå·²å„ªåŒ–ã€‚
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>

<script>
// ==========================================
// ã€è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ Firebase è¨­å®šã€‘
// ==========================================
const firebaseConfig = {
    apiKey: "AIzaSyAD48KJ3oobOE3IQX7o9WhF1eRC-Zd2J24",
    authDomain: "game-7c96b.firebaseapp.com",
    databaseURL: "https://game-7c96b-default-rtdb.firebaseio.com",
    projectId: "game-7c96b",
    storageBucket: "game-7c96b.firebasestorage.app",
    messagingSenderId: "325794018538",
    appId: "1:325794018538:web:3fa748f4f541f227579393"
};
// ==========================================

window.onerror = function(msg, url, line, col, error) {
    const box = document.getElementById('rescue-console');
    box.style.display = 'block';
    box.innerHTML = `<h3>ğŸš¨ ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤</h3><p>${msg}</p><p>ä½ç½®: Line ${line}</p><p>è«‹ç¢ºèª Firebase Config æ˜¯å¦å·²æ­£ç¢ºå¡«å…¥ï¼</p>`;
    return false;
};

// åˆå§‹åŒ– Firebase
let db;
try {
    if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("è«‹å¡«å…¥")) {
        throw new Error("è«‹æ‰“é–‹ index.html å¡«å¯«æ­£ç¢ºçš„ Firebase Configï¼");
    }
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
} catch (e) {
    window.onerror(e.message, "", 0);
}

// ç›£è½é€£ç·šç‹€æ…‹
const connectedRef = firebase.database().ref(".info/connected");
connectedRef.on("value", (snap) => {
    const el = document.getElementById('conn-status');
    if (snap.val() === true) {
        el.className = "status-dot online";
    } else {
        el.className = "status-dot offline";
    }
});

// --- è³‡æ–™è¨­å®š ---
const rawData = [
    { name: "åŸƒå¥‡ç´å¾·(25)", cd: 24, type: "fixed", loc: "ç‘ªé­¯æ£®æ—", fixTime: "12:00" },
    { name: "æ–¯å‰æ‹‰(30)", cd: 24, type: "fixed", loc: "é›²ä¹‹é«˜åŸ", fixTime: "14:00" },
    { name: "èœ¥èœ´äººåœ‹ç‹(35)", cd: 24, type: "fixed", loc: "è‰¾æ‹‰æº«æºªè°·", fixTime: "16:00" },
    { name: "äºçˆ¾è²¢(40)", cd: 24, type: "fixed", loc: "ç«ç´…è’é‡", fixTime: "18:00" },
    { name: "åšå¡é “(45)", cd: 24, type: "fixed", loc: "æ¥­å ±3F", fixTime: "20:00" },
    { name: "æ³°ç±³çˆ¾(48)", cd: 24, type: "fixed", loc: "å°¼å¤«èŠçˆ¾åŸ", fixTime: "22:00" },
    
    { name: "æ™®é­¯ç‰¹(65)", cd: 6, type: "cd", loc: "åœ°ç„3F", initTime: "1/8 10:15" },
    { name: "æ ¼é‡Œè²¢(55)", cd: 12, type: "cd", loc: "å€’è½‰ç«ç´…è’é‡", initTime: "1/8 15:15" },
    { name: "ä½©çˆ¾(77)", cd: 24, type: "cd", loc: "ç½ªæƒ¡3F", initTime: "1/8 15:15" },
    { name: "äºæ‹‰é‡‘(78)", cd: 24, type: "cd", loc: "é›·æ­åŸ", initTime: "1/8 15:19" }, 
    { name: "å¡å¨å› (85)", cd: 24, type: "cd", loc: "æ¥è¾±çš„ç¥å»Ÿ", initTime: "1/8 15:20" },
    { name: "å¸•ææ´›æ–¯(60)", cd: 6, type: "cd", loc: "å€’è½‰å¡ç´å…‹å³½è°·", initTime: "1/8 15:23" },
    { name: "EZ-09(62)", cd: 12, type: "cd", loc: "å€’è½‰å¤ä»£éºè·¡", initTime: "1/8 15:29" },
    { name: "ç¶­ç‘Ÿæ–¯(72)", cd: 9, type: "cd", loc: "æ‹‰ç±³æ–¯æ£®æ—", initTime: "1/8 18:28" },
    { name: "æ­¦åº«æ‹‰(50)", cd: 13.5, type: "cd", loc: "å€’è½‰è‰¾æ‹‰æº«æºªè°·", initTime: "1/8 18:14" },
    { name: "å¸ƒèŠç™»(63)", cd: 18, type: "cd", loc: "æ¥­å ±6F", initTime: "1/9 03:15" },
    { name: "å“ˆå°¼æ–‡(68)", cd: 18, type: "cd", loc: "ç‘ªå‹’è–©æµ·å²¸", initTime: "1/8 14:45" }
];

let bosses = [];

function parseInitTime(str) {
    if(!str) return null;
    try {
        const now = new Date();
        let year = now.getFullYear();
        let month = now.getMonth();
        let day = now.getDate();
        let dPart = "", tPart = str;
        if(str.includes(' ')) { const sp = str.split(' '); dPart = sp[0]; tPart = sp[1]; }
        if(dPart && dPart.includes('/')) { const dp = dPart.split('/'); month = parseInt(dp[0]) - 1; day = parseInt(dp[1]); }
        const tp = tPart.split(':');
        return new Date(year, month, day, parseInt(tp[0]), parseInt(tp[1]), 0).getTime();
    } catch(e) { return null; }
}

function init() {
    const hook = localStorage.getItem('zenonia_webhook_url');
    if(hook) document.getElementById('webhook-url').value = hook;

    db.ref('bosses').on('value', (snapshot) => {
        const val = snapshot.val();
        if (val) {
            bosses = val;
        } else {
            loadDefaults();
        }
        renderStaticList();
        updateTimers();
    }, (error) => {
        window.onerror("è®€å–è³‡æ–™å¤±æ•—: " + error.message, "", 0);
    });

    setInterval(() => {
        recalcFixedBosses();
        updateTimers();
    }, 1000);
}

function loadDefaults() {
    bosses = rawData.map((b, idx) => ({
        ...b,
        id: idx,
        nextSpawn: b.type === 'fixed' ? null : parseInitTime(b.initTime)
    }));
    saveData();
}

function recalcFixedBosses() {
    const now = new Date();
    bosses.forEach(boss => {
        if (boss.type === 'fixed' && boss.fixTime) {
            const [fh, fm] = boss.fixTime.split(':').map(Number);
            let target = new Date();
            target.setHours(fh, fm, 0, 0);
            if (now.getTime() > target.getTime()) {
                target.setDate(target.getDate() + 1);
            }
            boss.nextSpawn = target.getTime();
        }
    });
}

function renderStaticList() {
    const list = document.getElementById('bossList');
    if(!list) return;

    const sorted = [...bosses].sort((a,b) => {
        if(!a.nextSpawn) return 1;
        if(!b.nextSpawn) return -1;
        return a.nextSpawn - b.nextSpawn;
    });

    let html = "";
    sorted.forEach(boss => {
        let inputHtml = "";
        if (boss.type === 'fixed') {
            inputHtml = `<div class="auto-tag">ğŸ”„ è‡ªå‹•å¾ªç’°</div>`;
        } else {
            // [ä¿®æ”¹] æŒ‰éˆ•æ–‡å­—æ”¹ç‚º "æ›´æ–°æ“Šæ®ºæ™‚é–“"
            inputHtml = `
                <div class="input-row">
                    <input type="text" id="in-${boss.id}" class="datepicker" placeholder="é»æ“Šé¸æ“‡æ™‚é–“">
                    <button class="btn btn-update" onclick="update(${boss.id})">æ›´æ–°æ“Šæ®ºæ™‚é–“</button>
                </div>`;
        }

        html += `
            <div id="card-${boss.id}" class="boss-card">
                <div class="boss-info">
                    <div class="boss-top-row">
                        <div class="boss-name">${boss.name}</div>
                        <div class="boss-meta">${boss.type === 'fixed' ? 'å›ºå®š ' + boss.fixTime : 'CD:' + boss.cd + 'h'}</div>
                    </div>
                    <div class="boss-loc">ğŸ“ ${boss.loc}</div>
                    <div id="timer-${boss.id}" class="boss-timer">-- : --</div>
                    <div id="predict-${boss.id}" class="boss-predict">å‡ºç¾æ™‚é–“: ---</div>
                </div>
                <div class="input-group">${inputHtml}</div>
            </div>`;
    });
    list.innerHTML = html;

    // [ä¿®æ”¹] ç§»é™¤ defaultDateï¼Œè®“é è¨­å€¼ç‚ºç©ºç™½
    flatpickr(".datepicker", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        locale: "zh_tw",
        // defaultDate: new Date(),  <-- é€™è¡Œå·²ç§»é™¤ï¼Œç¢ºä¿é‡æ–°æ•´ç†æ™‚æ˜¯ç©ºç™½
        minuteIncrement: 1,
        disableMobile: "true"
    });
    
    updateTimers();
}

function updateTimers() {
    const now = new Date().getTime();
    bosses.forEach(boss => {
        const cardEl = document.getElementById(`card-${boss.id}`);
        const timerEl = document.getElementById(`timer-${boss.id}`);
        const predictEl = document.getElementById(`predict-${boss.id}`);
        if (!cardEl || !timerEl) return;

        let statusClass = "status-cd"; 
        let timerText = "-- : --";
        let predictText = "---";
        let isHighlight = false;

        if (boss.nextSpawn) {
            const diff = boss.nextSpawn - now;
            const d = new Date(boss.nextSpawn);
            
            // [ä¿®æ”¹] æ–‡æ¡ˆæ”¹ç‚º "å‡ºç¾æ™‚é–“"
            predictText = `å‡ºç¾æ™‚é–“: ${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

            if (diff <= 0) {
                statusClass = "status-active"; 
                timerText = "ğŸ”¥ å·²å‡ºç¾";
                isHighlight = true;
            } else {
                const hh = Math.floor(diff / 3600000);
                const mm = Math.floor((diff % 3600000) / 60000);
                const ss = Math.floor((diff % 60000) / 1000);
                // [ä¿®æ”¹] åŠ ä¸Š "å€’æ•¸" å‰ç¶´
                timerText = `å€’æ•¸ ${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;

                if (diff < 600000) { 
                    statusClass = "status-soon"; 
                    isHighlight = true;
                } else if (boss.type === 'fixed') {
                    statusClass = "status-fixed";
                }
            }
        }

        timerEl.innerText = timerText;
        predictEl.innerText = predictText;
        
        cardEl.classList.remove('status-active', 'status-soon', 'status-cd', 'status-fixed');
        if (statusClass) cardEl.classList.add(statusClass);
        if (isHighlight) timerEl.classList.add('highlight-text');
        else timerEl.classList.remove('highlight-text');
    });
}

function saveData() {
    db.ref('bosses').set(bosses).catch(e => alert("åŒæ­¥å¤±æ•—ï¼š" + e.message));
}

function saveWebhook() {
    const url = document.getElementById('webhook-url').value.trim();
    if(url) {
        localStorage.setItem('zenonia_webhook_url', url);
        alert("Webhook ç¶²å€å·²å„²å­˜ï¼");
    }
}

window.update = function(id) {
    const input = document.getElementById(`in-${id}`);
    
    // [ä¿®æ”¹] å¢åŠ é˜²å‘†ï¼Œå¦‚æœç©ºç™½å‰‡è­¦å‘Š
    if(!input || !input.value) return alert("è«‹å…ˆé»æ“Šé¸æ“‡æ“Šæ®ºæ™‚é–“ï¼Œå†æŒ‰ä¸‹æ›´æ–°ï¼");
    
    const killTime = new Date(input.value).getTime();
    if(isNaN(killTime)) return alert("æ™‚é–“æ ¼å¼éŒ¯èª¤");
    
    const bossIndex = bosses.findIndex(b => b.id === id);
    if (bossIndex === -1) return;
    
    const boss = bosses[bossIndex];

    if (boss.type === 'cd') {
        const addMin = boss.cd * 60;
        let nextTime = new Date(killTime);
        nextTime.setMinutes(nextTime.getMinutes() + addMin);
        boss.nextSpawn = nextTime.getTime();
        saveData();
        
        // æ›´æ–°æˆåŠŸå¾Œï¼Œæ¸…ç©ºè¼¸å…¥æ¡†ï¼Œé¿å…ä¸‹æ¬¡èª¤è§¸
        input.value = "";
    }
};

window.hardReset = function() {
    if(confirm("ç¢ºå®šè¦é‡ç½®ã€Œé›²ç«¯ã€æ‰€æœ‰æ•¸æ“šå›é è¨­å€¼å—ï¼Ÿé€™æœƒå½±éŸ¿æ‰€æœ‰äººï¼")) {
        loadDefaults();
    }
};

window.copyToClipboard = function() {
    const list = getSortedList();
    const text = formatListText(list);
    navigator.clipboard.writeText(text).then(()=>alert("å·²è¤‡è£½æ–‡å­—ï¼")).catch(()=>alert("è¤‡è£½å¤±æ•—"));
};

window.sendToDiscord = function() {
    const url = document.getElementById('webhook-url').value.trim();
    if (!url) return alert("è«‹å…ˆå¡«å…¥ Webhook ç¶²å€ä¸¦å„²å­˜ï¼");
    
    const list = getSortedList();
    const description = formatListText(list, false);
    
    const payload = {
        username: "æœˆæ­¸ä¿ç§˜æ›¸",
        embeds: [{
            title: "ğŸ“¢èµ·åºŠåƒç‹å•¦",
            description: description + "\n\nğŸ”— [é–‹å•Ÿå·¥å…·ç¶²é ](https://willa0916.github.io/zenonia-boss/)",
            color: 5814783, 
            footer: { text: "æ›´æ–°æ™‚é–“: " + new Date().toLocaleTimeString('zh-TW', { hour12: false }) }
        }]
    };

    fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) })
    .then(res => { if(res.ok) alert("âœ… å·²ç™¼é€åˆ° Discordï¼"); else alert("âŒ ç™¼é€å¤±æ•—"); })
    .catch(err => alert("âŒ éŒ¯èª¤: " + err));
};

function getSortedList() {
    const now = new Date().getTime();
    return [...bosses].filter(b => b.nextSpawn).sort((a,b) => a.nextSpawn - b.nextSpawn);
}

function formatListText(list, isCodeBlock = true) {
    const now = new Date().getTime();
    let text = "";
    if(isCodeBlock) {
        text += "ğŸ“¢ **åƒç‹æ™‚é–“è¡¨**\nğŸ”— https://willa0916.github.io/zenonia-boss/\n\n```diff\n";
    }
    list.forEach(b => {
        const d = new Date(b.nextSpawn);
        const tStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        const diff = b.nextSpawn - now;
        let icon = "-";
        if (diff <= 0) icon = "+";
        else if (diff < 600000) icon = "!";
        
        if (isCodeBlock) {
            text += `${icon} ${b.name} (${b.loc})\n      æ™‚é–“: ${tStr}\n`;
        } else {
            let statusEmoji = "â³";
            if(diff <= 0) statusEmoji = "ğŸ”¥ **å·²å‡ºç¾**";
            else if(diff < 600000) statusEmoji = "âš ï¸ **å³å°‡å‡ºç¾**";
            text += `${statusEmoji} **${b.name}**\nğŸ“ ${b.loc} ğŸ•’ **${tStr}**\n\n`;
        }
    });
    if(isCodeBlock) text += "```";
    return text;
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>
</body>
</html>

